# ğŸ“¬ **LeafPost**(ë©”ì¼ ì†¡ì‹  ì˜ˆì•½ ì‹œìŠ¤í…œ)

---

## 1. í”„ë¡œì íŠ¸ ê°œìš” ğŸŒ±

**ëª©ì **

ì‚¬ìš©ìê°€ **ë™ë¬¼ì˜ ìˆ² ì£¼ë¯¼ ìºë¦­í„°(ì´í•˜ ì£¼ë¯¼)**ì„ ì„ íƒí•˜ì—¬ ì…ë ¥í•œ í…ìŠ¤íŠ¸ë¥¼ **í•´ë‹¹ ì£¼ë¯¼ì˜ ë§íˆ¬(Tone)**ë¡œ ë³€í™˜í•œ ë’¤

ğŸ‘‰ **ì´ë¯¸ì§€ ë˜ëŠ” í…ìŠ¤íŠ¸ í˜•íƒœì˜ ì´ë©”ì¼**ë¡œ ì˜ˆì•½/ì¦‰ì‹œ ì†¡ì‹ í•  ìˆ˜ ìˆëŠ” ì„œë¹„ìŠ¤ ì œì‘

**í•µì‹¬ ê°€ì¹˜**

- ìºë¦­í„° ê¸°ë°˜ ê°ì„± ì»¤ë®¤ë‹ˆì¼€ì´ì…˜
- ë§íˆ¬(Tone) ì¤‘ì‹¬ ì½˜í…ì¸  ë³€í™˜
- ì˜ˆì•½ ì†¡ì‹  + ì´ë ¥ ê´€ë¦¬ì— íŠ¹í™”ëœ ê°œì¸í™” ì„œë¹„ìŠ¤

```tsx
// ì „ì²´ êµ¬ì¡° ë‹¤ì´ì–´ê·¸ë¨

[ì‚¬ìš©ì]
   â”‚
   â–¼
[ì›¹/ì•± ì ‘ì†]
   â”‚
   â”œâ”€ ë¹„íšŒì› â†’ [í™˜ì˜í™”ë©´ â†’ ë¡œê·¸ì¸/íšŒì›ê°€ì…]
   â”‚
   â””â”€ ë¡œê·¸ì¸ â†’ [ë©”ì¸ í˜ì´ì§€]
                 â”‚
                 â”œâ”€ ì£¼ë¯¼ ë¦¬ìŠ¤íŠ¸ (ì¹´ë“œ UI + ì¸ê¸° ë­í‚¹)
                 â”‚       â”‚
                 â”‚       â””â”€ í˜¸ë²„ â†’ ë§íˆ¬ ì˜ˆì‹œ
                 â”‚       â””â”€ í´ë¦­ â†’ ì´ë©”ì¼ ì†¡ì‹  ì¹´ë“œ ë…¸ì¶œ
                 â”‚
                 â””â”€ ë§ˆì´í˜ì´ì§€
                         â”œâ”€ í”„ë¡œí•„ ê´€ë¦¬
                         â””â”€ ì´ë©”ì¼ ì´ë ¥
                                 â”œâ”€ ì˜ˆì•½ ì´ë©”ì¼ (ì·¨ì†Œ ê°€ëŠ¥)
                                 â””â”€ ë³´ë‚¸ ì´ë©”ì¼ (ì‚­ì œ ê°€ëŠ¥)
```

---

## 2. ê¸°ìˆ  ìŠ¤íƒ ğŸ› ï¸

**í”„ë¡ íŠ¸ì—”ë“œ**

- Next.js (App Router)
- ë°°í¬: Vercel

**ë°±ì—”ë“œ**

- NestJS, TypeORM, PostgreSQL
- **GPT Api(ì£¼ë¯¼ ë§íˆ¬ ë³€í™˜ ìµœì¢… ê²°ì •, src/infra/ ì—ì„œ ê´€ë¦¬)**
- **Redis (ì¸ê¸° ì£¼ë¯¼ ë­í‚¹, src/infra/ ì—ì„œ ê´€ë¦¬)**
- Supabase Storage (ì´ë¯¸ì§€ ì €ì¥)
- ë°°í¬: Render

---

## 3. ì—­í•  ë¶„ë‹´ ğŸ‘¥

### í”„ë¡ íŠ¸ì—”ë“œ ë‹´ë‹¹

- ë¡œê·¸ì¸/íšŒì›ê°€ì… UI
- ì£¼ë¯¼ ë¦¬ìŠ¤íŠ¸ ë° ì¸ê¸° ë­í‚¹ UI
- ì´ë©”ì¼ ì˜ˆì•½/ì†¡ì‹  ì¹´ë“œ UI
- ë§ˆì´í˜ì´ì§€ (ì´ë©”ì¼ ì´ë ¥, í”„ë¡œí•„)
- API ì—°ë™ ë° ìƒíƒœ ê´€ë¦¬
- **ì£¼ë¯¼ ë§íˆ¬ ì ìš© ë° ì¹´ë“œ UI/UX êµ¬í˜„**

### ë°±ì—”ë“œ ë‹´ë‹¹

- Auth ì‹œìŠ¤í…œ (JWT + Refresh Token)
- ì£¼ë¯¼/ë§íˆ¬ ë°ì´í„° ê´€ë¦¬
- ì´ë©”ì¼ ì˜ˆì•½ & ìƒíƒœ ê´€ë¦¬
- Redis ê¸°ë°˜ ì¸ê¸° ì£¼ë¯¼ ì§‘ê³„
- (ì¶”í›„) ì´ë¯¸ì§€ ìƒì„± ë¡œì§ ê²€í†  ë° êµ¬í˜„

```tsx
// í”„ë¡ íŠ¸ & ë°±ì—”ë“œ ì—­í• 

í”„ë¡ íŠ¸ì—”ë“œ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì¹´ë“œ UI / ë§íˆ¬ ì ìš©           â”‚
â”‚ ì£¼ë¯¼ ë¦¬ìŠ¤íŠ¸ / ì¸ê¸° ìˆœìœ„ UI    â”‚
â”‚ ì´ë©”ì¼ ì˜ˆì•½ ì…ë ¥ / ì†¡ì‹  ì¹´ë“œ â”‚
â”‚ ë§ˆì´í˜ì´ì§€ ì¹´ë“œ ì´ë ¥ í‘œì‹œ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ë°±ì—”ë“œ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Auth / JWT í† í° ê´€ë¦¬         â”‚
â”‚ DB: Users, Villagers, Emails â”‚
â”‚ Redis ì¸ê¸° ì£¼ë¯¼ ì§‘ê³„          â”‚
â”‚ ì´ë©”ì¼ ì˜ˆì•½, ì „ì†¡, ìƒíƒœ ê´€ë¦¬ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. ì‚¬ìš©ì í”Œë¡œìš° ğŸ”

### 1) ê¸°ë³¸ ë„ë©”ì¸ ì ‘ì†

- í™˜ì˜ ë¬¸êµ¬
- ë¡œê·¸ì¸ / íšŒì›ê°€ì… ë²„íŠ¼ ì œê³µ

### 2) íšŒì›ê°€ì… í˜ì´ì§€

- ì…ë ¥: ì´ë©”ì¼, ë¹„ë°€ë²ˆí˜¸, ë‹‰ë„¤ì„
- ê°€ì… ì„±ê³µ â†’ ë¡œê·¸ì¸ í˜ì´ì§€ ì´ë™

### 3) ë¡œê·¸ì¸ í˜ì´ì§€

- ì´ë©”ì¼ / ë¹„ë°€ë²ˆí˜¸ ì…ë ¥
- ë¡œê·¸ì¸ ì„±ê³µ â†’ ë©”ì¸ í˜ì´ì§€

### 4) ë©”ì¸ í˜ì´ì§€ ğŸï¸

**ì£¼ë¯¼ ë¦¬ìŠ¤íŠ¸**

- ëª¨ë“  ì£¼ë¯¼ ìºë¦­í„° ì¹´ë“œ í‘œì‹œ
- ì¹´ë“œ êµ¬ì„±: ì£¼ë¯¼ ì´ë¯¸ì§€, ì´ë¦„, ì¸ê¸° ë°°ì§€ (Redis ê¸°ë°˜)

**ì¸í„°ë™ì…˜**

- ë§ˆìš°ìŠ¤ í˜¸ë²„ â†’ ì£¼ë¯¼ ë§íˆ¬ ì˜ˆì‹œ í‘œì‹œ
- ì£¼ë¯¼ í´ë¦­ â†’ ì´ë©”ì¼ ì†¡ì‹  ì¹´ë“œ ë…¸ì¶œ

---

### 5) ì´ë©”ì¼ ì†¡ì‹  ì¹´ë“œ âœ‰ï¸

**ì…ë ¥ ì •ë³´**

- ì˜ˆì•½ ë‚ ì§œ ë° ì‹œê°„
- ë°›ëŠ” ì‚¬ëŒ ì´ë©”ì¼
- ë³€í™˜í•  í…ìŠ¤íŠ¸
- ì„ íƒëœ ì£¼ë¯¼ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°

**ê³ ì • ì •ë³´**

- ë³´ë‚´ëŠ” ì‚¬ëŒ ì´ë©”ì¼: íšŒì›ê°€ì… ì‹œ ì‚¬ìš©í•œ ì´ë©”ì¼

**UX/ë™ì‘ íë¦„ (í”„ë¡ íŠ¸ ì ìš©)**

- ì‚¬ìš©ì í…ìŠ¤íŠ¸ ì…ë ¥ â†’ ì£¼ë¯¼ ë§íˆ¬(Tone) ì ìš© â†’ ì¹´ë“œ ë‚´ ì‹¤ì‹œê°„ ë³€í™˜
- ì¹´ë“œ êµ¬ì¡° : Background + Villager Sticker + Speech Bubble + TextSafeArea
- ì£¼ë¯¼ë³„ Variant : ì»¬ëŸ¬/ìŠ¤í‹°ì»¤/ë§í’ì„  ë³€ê²½ ê°€ëŠ¥
- ì˜ˆì•½ ë˜ëŠ” ì¦‰ì‹œ ì´ë©”ì¼ ì†¡ì‹ 
- ì´ë©”ì¼ ì „ì†¡ ì‹œì ì—ì„œëŠ” **MVPì—ì„œëŠ” í…ìŠ¤íŠ¸ ê¸°ë°˜**, ì´ë¯¸ì§€ ìƒì„±ì€ ì¶”í›„ í™•ì¥

  ### 5-1) ë©”ì¼ ì¹´ë“œ êµ¬ì¡°(í”„ë¡ íŠ¸ ë ˆì´ì–´)

  ```tsx
  MailCard_Base (Frame 360x480)
   â”œâ”€ Background (ë°°ê²½ ìƒ‰ìƒ/í…ìŠ¤ì²˜)
   â”œâ”€ VillagerSticker (ì£¼ë¯¼ ì–¼êµ´ ì´ë¯¸ì§€/ìŠ¤í‹°ì»¤)
   â”œâ”€ SpeechBubble (ë§í’ì„ , Tail ë°©í–¥ ìºë¦­í„° ìª½)
   â””â”€ TextSafeArea (ì‚¬ìš©ì ì…ë ¥ ì˜ì—­, React textarea)
  ```

  - **ì£¼ë¯¼ë³„ Variant**
    - ì»¬ëŸ¬, ìŠ¤í‹°ì»¤, ë§í’ì„ ë§Œ ë³€ê²½
    - TextSafeAreaëŠ” ê³µí†µ, ë§ë²„ë¦‡ ë³€í™˜ ì ìš©
  - **ë™ì‘**
    - ì‚¬ìš©ìê°€ í…ìŠ¤íŠ¸ ì…ë ¥ â†’ ë§ë²„ë¦‡ ì ìš© â†’ ì¹´ë“œ ë‚´ ì‹¤ì‹œê°„ ë°˜ì˜
    - ì˜ˆì•½/ì¦‰ì‹œ ì „ì†¡ ë²„íŠ¼ ì—°ê²°

---

### 6) ë§ˆì´í˜ì´ì§€ ğŸ“‚

**í”„ë¡œí•„**

- ì´ë©”ì¼, ë‹‰ë„¤ì„, ë¹„ë°€ë²ˆí˜¸ ë³€ê²½

**ì´ë©”ì¼ ì´ë ¥ ê´€ë¦¬**

- ì¹´ë“œ í˜•íƒœë¡œ ì œê³µ
- ë³´ë‚¼ ì´ë©”ì¼ : ì˜ˆì•½ ìƒíƒœ í‘œì‹œ, ì·¨ì†Œ ê°€ëŠ¥
- ë³´ë‚¸ ì´ë©”ì¼ : ì†¡ì‹  ì™„ë£Œ í‘œì‹œ, ê¸°ë¡ ì‚­ì œ ê°€ëŠ¥
- ì¹´ë“œ ë‚´ ì£¼ë¯¼ ì´ë¯¸ì§€ + ë³€í™˜ëœ í…ìŠ¤íŠ¸ í•¨ê»˜ í‘œì‹œ

---

## 7. ë°±ì—”ë“œ êµ¬ì¡° âš™ï¸

**ë¦¬ì†ŒìŠ¤ êµ¬ì„±**

- **Auth** : ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ, Access/Refresh Token, ì¸ì¦/ì¸ê°€
- **Users** : íšŒì›ê°€ì…, ë‹‰ë„¤ì„/ë¹„ë°€ë²ˆí˜¸ ë³€ê²½, íšŒì› íƒˆí‡´, ë‚´ ì •ë³´ ì¡°íšŒ
- **Villagers** : ì£¼ë¯¼ ì¡°íšŒ, ì£¼ë¯¼ ì‚¬ìš©ëŸ‰ ì¦ê°€ (Redis ì—°ë™)
- **Emails** : ì´ë©”ì¼ ìƒì„±, ì˜ˆì•½, ì·¨ì†Œ, ìƒíƒœ ê´€ë¦¬

---

## 8. ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„ ğŸ—„ï¸

### users

CREATE TABLE users (
id UUID PRIMARY KEY,
email VARCHAR(255) UNIQUE NOT NULL,
password VARCHAR(255) NOT NULL,
nickname VARCHAR(50) NOT NULL,
created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

### villagers

CREATE TABLE villagers (
id SERIAL PRIMARY KEY,
name VARCHAR(100) NOT NULL,
image_url TEXT NOT NULL,
created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

### villager_tones

CREATE TABLE villager_tones (
id SERIAL PRIMARY KEY,
villager_id INT NOT NULL REFERENCES villagers(id) ON DELETE CASCADE,
-- ê³µí†µ ë§íˆ¬ ì •ë³´
speech_style VARCHAR(50),
sentence_ending VARCHAR(50),
personality_keywords TEXT,
example_sentences TEXT,
-- Tone íƒ€ì…
tone_type VARCHAR(20) NOT NULL CHECK (tone_type IN ('RULE', 'GPT', 'HYBRID')),
-- GPT ì „ìš©
system_prompt TEXT,
max_length INT,
forbid_emotion BOOLEAN DEFAULT false,
created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

### emails

CREATE TABLE emails (
id UUID PRIMARY KEY,
status VARCHAR(20) NOT NULL CHECK (
status IN ('reserved', 'sent', 'canceled', 'failed')
),

user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
villager_id INT NOT NULL REFERENCES villagers(id),

sender_email VARCHAR(255) NOT NULL,
receiver_email VARCHAR(255) NOT NULL,

original_text TEXT NOT NULL,
transformed_text TEXT,

image_url TEXT,
scheduled_at TIMESTAMP WITH TIME ZONE,
created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

### refresh_tokens

CREATE TABLE refresh_tokens (
id SERIAL PRIMARY KEY,
token VARCHAR(255) NOT NULL,
is_revoked BOOLEAN DEFAULT false,
expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE
);

---

## 9. Redis ì„¤ê³„ ğŸ”¥

- ì£¼ë¯¼ ì‚¬ìš© ì‹œë§ˆë‹¤ ì¦ê°€: **`ZINCRBY villager_ranking villagerId1`**
- ìƒìœ„ ì£¼ë¯¼ ì¡°íšŒ: **`ZREVRANGE villager_ranking 0 9 WITHSCORES`**

---

## 10. ë¯¸ì • / ì¶”ê°€ ë…¼ì˜ âš ï¸

- ì´ë¯¸ì§€ ìƒì„± ë¡œì§ (ë°±ì—”ë“œ ì²˜ë¦¬ ì—¬ë¶€, ì™¸ë¶€ ì„œë¹„ìŠ¤ ì—°ë™)
- MVPì—ì„œëŠ” **text-only ì´ë©”ì¼** ì†¡ì‹ ìœ¼ë¡œ ì‹œì‘, imageUrl nullable
- NextJSì˜ sharp ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©í•´ì„œ ì´ë¯¸ì§€ í•©ì„± ì‹œë„ ì˜ˆì •

---

## 11. í”„ë¡ íŠ¸ì—”ë“œ ë‹´ë‹¹ UX/ë””ìì¸ ì •ë¦¬ ğŸ§©

- ì¹´ë“œ UI : **360Ã—480 ë˜ëŠ” 400Ã—520**, ëª¨ë°”ì¼/ì›¹ ëŒ€ì‘
- ì£¼ë¯¼ ì„ íƒ â†’ ì¹´ë“œ ë‚´ ì‹¤ì‹œê°„ ë§íˆ¬ ë³€í™˜
- ì¹´ë“œ êµ¬ì„± : Background + Villager Sticker + Speech Bubble + TextSafeArea
- ë§ˆì´í˜ì´ì§€ : ë³´ë‚¸/ì˜ˆì•½ ì´ë©”ì¼ **ì¹´ë“œ í˜•íƒœë¡œ í‘œì‹œ**, ì‹¤ì œ ì†¡ì‹  ëª¨ìŠµ ë¯¸ë¦¬ë³´ê¸° ê°€ëŠ¥
- í”„ë¡ íŠ¸ëŠ” **UX/ì¸í„°ë™ì…˜ + ë§ë²„ë¦‡ ë³€í™˜**, ë°±ì—”ë“œëŠ” **ë°ì´í„°/ì˜ˆì•½/ì´ë©”ì¼ ì „ì†¡** ë‹´ë‹¹

---

## 12. ë³€í™˜ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì‹œìŠ¤í…œğŸ–¼ï¸

### 1. ëª©ì  ë° ë²”ìœ„

**ëª©ì **

- ì‚¬ìš©ìê°€ ì´ë©”ì¼ì„ ì˜ˆì•½/ì „ì†¡í•˜ê¸° ì „ì—
  **ì„ íƒí•œ ì£¼ë¯¼ ë§íˆ¬ê°€ ì ìš©ëœ ê²°ê³¼ë¥¼ ì‹œê°ì ìœ¼ë¡œ í™•ì¸**í•  ìˆ˜ ìˆë„ë¡ í•œë‹¤.
- ì‹¤ì œ ì €ì¥Â·ì†¡ì‹  ë¡œì§ê³¼ **ì™„ì „íˆ ë¶„ë¦¬ëœ ë¯¸ë¦¬ë³´ê¸° ì‹œìŠ¤í…œ**ì„ ì œê³µí•œë‹¤.

**ë²”ìœ„**

- ë³¸ ì‹œìŠ¤í…œì€ **ì €ì¥, ì˜ˆì•½, ì´ë©”ì¼ ì†¡ì‹ ê³¼ ë¬´ê´€**
- **ë¯¸ë¦¬ë³´ê¸° ì „ìš©**ì´ë©°, ë°ì´í„°ë² ì´ìŠ¤ì— ì–´ë– í•œ ì´ë ¥ë„ ë‚¨ê¸°ì§€ ì•ŠëŠ”ë‹¤.

---

### 2. ì‹œìŠ¤í…œ ì›ì¹™ (ì¤‘ìš”)

- ë¯¸ë¦¬ë³´ê¸° ê²°ê³¼ëŠ” **ì°¸ê³ ìš©**
- ìµœì¢… ë³€í™˜ ê²°ê³¼ëŠ” **ë°±ì—”ë“œì—ì„œ ë‹¤ì‹œ ìƒì„±**
- ë¯¸ë¦¬ë³´ê¸°ì™€ ì‹¤ì œ ê²°ê³¼ëŠ” ìœ ì‚¬í•¨ì„ ëª©í‘œë¡œ í•˜ë˜, ì™„ì „ ë™ì¼ì„±ì„ ë³´ì¥í•˜ì§€ ì•ŠëŠ”ë‹¤

---

### 3. í”„ë¡ íŠ¸ì—”ë“œ ì±…ì„ (Preview UI) ğŸ¨

**ì—­í• **

- ì‚¬ìš©ì ì…ë ¥ ê´€ë¦¬
- ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° UX ì œê³µ
- ì¹´ë“œ/ë§í’ì„ /ë°°ê²½ ë ˆì´ì•„ì›ƒ ë Œë”ë§

**ì²˜ë¦¬ íë¦„**

1. ì‚¬ìš©ìê°€ í…ìŠ¤íŠ¸ ì…ë ¥
2. ì„ íƒí•œ ì£¼ë¯¼ ID ê¸°ì¤€ìœ¼ë¡œ ë¯¸ë¦¬ë³´ê¸° ìš”ì²­
3. ë°˜í™˜ëœ ë¯¸ë¦¬ë³´ê¸° í…ìŠ¤íŠ¸ ë° ì´ë¯¸ì§€ URLì„ UIì— ë Œë”ë§

**í”„ë¡ íŠ¸ì—”ë“œì—ì„œ í•˜ì§€ ì•ŠëŠ” ê²ƒ**

- ë§íˆ¬ ê·œì¹™ ì •ì˜
- ìµœì¢… ë³€í™˜ ë¡œì§
- ì´ë¯¸ì§€ ìƒì„± ë¡œì§

---

### 4. ë°±ì—”ë“œ ì±…ì„ (Preview Engine) âš™ï¸

**ì—­í• **

- ì£¼ë¯¼ ë§íˆ¬ ê·œì¹™ ì¡°íšŒ (`villager_tones`)
- **ì£¼ë¯¼ì˜ ë§íˆ¬ ë³€í™˜ ê·œì¹™ì€ src/domain/ ì—ì„œ ê´€ë¦¬**
- ë¯¸ë¦¬ë³´ê¸°ìš© ë³€í™˜ ë¡œì§ ì‹¤í–‰
- (ì„ íƒ) ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ ìƒì„±
- **ì ˆëŒ€ DBì— ì €ì¥í•˜ì§€ ì•ŠìŒ**

**ë¯¸ë¦¬ë³´ê¸° ë¡œì§ íŠ¹ì§•**

- ëœë¤ì„± ìµœì†Œí™”
- ê²°ì •ì (deterministic) ê²°ê³¼ ë°˜í™˜
- UX ì•ˆì •ì„± ìš°ì„ 

---

### 5. ë¯¸ë¦¬ë³´ê¸° ì²˜ë¦¬ ì‹œí€€ìŠ¤ ğŸ”

```
[Frontend]
í…ìŠ¤íŠ¸ ì…ë ¥
   â†“
POST /emails/preview
   â†“
[Backend]
tone rule ì¡°íšŒ
preview ë³€í™˜ ìˆ˜í–‰
(ì„ íƒ) ì´ë¯¸ì§€ ìƒì„±
   â†“
ë¯¸ë¦¬ë³´ê¸° ê²°ê³¼ ë°˜í™˜
   â†“
[Frontend]
ì¹´ë“œ UIì— ë Œë”ë§
```

---

### 6. ë¯¸ë¦¬ë³´ê¸° ì‘ë‹µ ì˜ˆì‹œ

```json
{
  "previewText": "ìŒâ€¦ ì˜¤ëŠ˜ ì§„ì§œ ê³ ë§ˆì› ì–´~",
  "previewImageUrl": "https://preview-image-url"
}
```

â€» `previewImageUrl`ì€ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì œê³µí•˜ì§€ ì•ŠëŠ” MVP ë‹¨ê³„ì—ì„œëŠ” `null` í—ˆìš©

---

## 13. GPT ê¸°ë°˜ ë§íˆ¬ ë³€í™˜ ì‹œìŠ¤í…œ ğŸ“±

### 1. ë„ì… ëª©ì 

ê¸°ì¡´ Rule ê¸°ë°˜ ë§íˆ¬ ë³€í™˜ ë°©ì‹ì€ **ì¼ê´€ì„±Â·ì†ë„Â·í”„ë¦¬ë·° UX** ì¸¡ë©´ì—ì„œ ìœ ë¦¬í•˜ë‚˜,

í‘œí˜„ ë‹¤ì–‘ì„±ê³¼ ìì—°ìŠ¤ëŸ¬ì›€ì— í•œê³„ë¥¼ ë³´ì™„í•˜ê¸° ìœ„í•´ **GPT APIë¥¼ â€œìµœì¢… ë³€í™˜ ì—”ì§„â€ìœ¼ë¡œ ì œí•œì ìœ¼ë¡œ ë„ì…**

---

### 2. GPT ì‚¬ìš© ë²”ìœ„ (ëª…í™•í•œ ê²½ê³„)

**GPT ì‚¬ìš© O**

- ìµœì¢… ì´ë©”ì¼ ì†¡ì‹  ì‹œ ë§íˆ¬ ë³€í™˜
- Tone íƒ€ì…ì´ `GPT` ë˜ëŠ” `HYBRID`ì¸ ê²½ìš°
- ì„œë²„ì—ì„œë§Œ í˜¸ì¶œ

**GPT ì‚¬ìš© X**

- í”„ë¡ íŠ¸ì—”ë“œ ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°
- ì‚¬ìš©ì ì…ë ¥ ì¤‘ê°„ ë‹¨ê³„
- ë§íˆ¬ ê·œì¹™ ì •ì˜ ìì²´
- Tone ë°ì´í„° ì €ì¥

> GPTëŠ” ë³€í™˜ ë„êµ¬ì´ì§€ ë„ë©”ì¸ ë¡œì§ì˜ ì£¼ì²´ê°€ ì•„ë‹˜

---

### 3. Tone íƒ€ì… í™•ì¥ ì •ì˜

**villager_tones.tone_type**

| ê°’     | ì„¤ëª…                |
| ------ | ------------------- |
| RULE   | ê¸°ì¡´ ê·œì¹™ ê¸°ë°˜ ë³€í™˜ |
| GPT    | GPT ê¸°ë°˜ ë§íˆ¬ ë³€í™˜  |
| HYBRID | Rule + GPT í˜¼í•©     |

---

### 4. Tone ë°ì´í„° êµ¬ì¡° (GPT ëŒ€ì‘)

**villager_tones í…Œì´ë¸” í•„ë“œ í™•ì¥**

| í•„ë“œ            | ì„¤ëª…                   |
| --------------- | ---------------------- |
| system_prompt   | GPT system ë©”ì‹œì§€      |
| base_rules      | Rule ê¸°ë°˜ í›„ì²˜ë¦¬ ê·œì¹™  |
| gpt_constraints | ê¸¸ì´, í‘œí˜„ ì œí•œ        |
| preview_rules   | í”„ë¡ íŠ¸ ë¯¸ë¦¬ë³´ê¸°ìš© ê·œì¹™ |

### ì˜ˆì‹œ

```json
{
  "tone_type": "GPT",
  "system_prompt": "ë„ˆëŠ” ë™ë¬¼ì˜ ìˆ² ì£¼ë¯¼ 'ë ˆì´ëª¬ë“œ'ë‹¤. ì°¨ë¶„í•˜ê³  ì•½ê°„ ì‹œë‹ˆì»¬í•œ ë§íˆ¬ë¥¼ ì‚¬ìš©í•œë‹¤.",
  "gpt_constraints": {
    "maxLength": 300,
    "forbiddenWords": ["ìš•ì„¤", "ê³¼ë„í•œ ê°ì • í‘œí˜„"]
  },
  "preview_rules": {
    "sentenceEnding": "â€¦"
  }
}
```

---

### 5. GPT ë³€í™˜ ì²˜ë¦¬ íë¦„ (ì„œë²„)

**ìµœì¢… ì´ë©”ì¼ ìƒì„± ì‹œ**

1. ì‚¬ìš©ì ì›ë¬¸ ìˆ˜ì‹ 
2. villagers â†’ villager_tones ì¡°íšŒ
3. tone_type ë¶„ê¸°
4. GPT ë³€í™˜ ìˆ˜í–‰
5. ê²°ê³¼ ê²€ì¦ ë° í›„ì²˜ë¦¬
6. emails í…Œì´ë¸”ì— ìµœì¢… ê²°ê³¼ ì €ì¥

**ì²˜ë¦¬ ì˜ì‚¬ ì½”ë“œ**

```tsx
if (tone.type === 'GPT') {
  result = gptTransform(input, tone.systemPrompt);
  result = postProcess(result, tone.baseRules);
}
```

---

### 6. GPT Prompt ì„¤ê³„ ì›ì¹™

**System Prompt (ê³ ì •)**

- ìºë¦­í„° ì •ì²´ì„±
- ë§íˆ¬ ì„±ê²©
- í‘œí˜„ ì œí•œ

**User Prompt (ê°€ë³€)**

- ì‚¬ìš©ì ì…ë ¥ ì›ë¬¸ë§Œ í¬í•¨

**ì˜ˆì‹œ**

System:

```
ë„ˆëŠ” ë™ë¬¼ì˜ ìˆ² ì£¼ë¯¼'ì­ˆë‹ˆ'ë‹¤.
í•­ìƒ ë°ê³  ê·€ì—½ê²Œ ë§í•˜ë©° ë¬¸ì¥ ëì—"ëƒ¥~"ì„ ë¶™ì¸ë‹¤.
```

User:

```
ì•„ë˜ ë¬¸ì¥ì„ ì­ˆë‹ˆì˜ ë§íˆ¬ë¡œ ë°”ê¿”ì¤˜:
"ì˜¤ëŠ˜ ì •ë§ ê³ ë§ˆì› ì–´."
```

---

### 7. ê²°ê³¼ ê²€ì¦ ë° ì•ˆì „ì¥ì¹˜

GPT ê²°ê³¼ëŠ” **ê·¸ëŒ€ë¡œ ì‹ ë¢°í•˜ì§€ ì•ŠëŠ”ë‹¤**.

**í•„ìˆ˜ ê²€ì¦ í•­ëª©**

- ë¹ˆ ë¬¸ìì—´ ì—¬ë¶€
- ìµœëŒ€ ê¸¸ì´ ì´ˆê³¼ ì—¬ë¶€
- ê¸ˆì¹™ì–´ í¬í•¨ ì—¬ë¶€

**í›„ì²˜ë¦¬**

- ë¬¸ì¥ ë ê·œì¹™ ê°•ì œ
- ì¤„ë°”ê¿ˆ ì •ë¦¬
- Rule ê¸°ë°˜ ë³´ì •

---

### 8. í”„ë¦¬ë·°ì™€ GPTì˜ ê´€ê³„

**í”„ë¡ íŠ¸ì—”ë“œ**

- preview_rules ê¸°ë°˜ Rule ë³€í™˜
- GPT í˜¸ì¶œ ì—†ìŒ

**ì„œë²„**

- ìµœì¢… ë³€í™˜ ì‹œ GPT í˜¸ì¶œ
- í”„ë¦¬ë·° ê²°ê³¼ì™€ ì™„ì „ ì¼ì¹˜ ë³´ì¥ ëŒ€ìƒ ì•„ë‹˜

> í”„ë¦¬ë·°ëŠ” â€œì˜ˆìƒ UIâ€, GPT ê²°ê³¼ëŠ” â€œí™•ì • ë°ì´í„°â€

---

### 9. ì¥ì•  ë° ë¹„ìš© ëŒ€ì‘ ì „ëµ

- GPT ì‹¤íŒ¨ ì‹œ Rule ê¸°ë°˜ fallback
- tone_typeë³„ GPT ì‚¬ìš© ì—¬ë¶€ ì œì–´
- í˜¸ì¶œ íšŸìˆ˜ ì œí•œ (ë©”ì¼ 1ê±´ë‹¹ 1íšŒ)

---

## 14. API ëª…ì„¸ğŸ”Œ

### 1. Auth

**POST /auth/login**

- ë¡œê·¸ì¸
- Access Token / Refresh Token ë°œê¸‰

**POST /auth/refresh**

- Refresh Token ê¸°ë°˜ Access Token ì¬ë°œê¸‰

**POST /auth/logout**

- ë¡œê·¸ì•„ì›ƒ
- Refresh Token íê¸°

ğŸ“Œ **GET â†’ POST ë³€ê²½ ê¶Œì¥**

- ì¸ì¦ ìƒíƒœ ë³€ê²½ì€ í•­ìƒ POST

| **ë©”ì„œë“œ** | **ì—”ë“œí¬ì¸íŠ¸** | **ì—­í• **                 |
| ---------- | -------------- | ------------------------ |
| **POST**   | /auth/login    | ë¡œê·¸ì¸                   |
| **POST**   | /auth/logout   | ë¡œê·¸ì•„ì›ƒ                 |
| **POST**   | /auth/refresh  | ìƒˆë¡œê³ ì¹¨ ì‹œ í† í° ì¬ ë°œê¸‰ |

---

### 2. Users

**POST /users/signup**

- íšŒì›ê°€ì…

**GET /users/me**

- ë‚´ í”„ë¡œí•„ ì¡°íšŒ

**PATCH /users/password**

- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½

**PATCH /users/nickname**

- ë‹‰ë„¤ì„ ë³€ê²½

**DELETE /users/me**

- íšŒì› íƒˆí‡´

ğŸ“Œ **/users/:id ì‚­ì œ ê¶Œí•œ ì œê±°**

- ë³¸ì¸ë§Œ ì‚­ì œ ê°€ëŠ¥í•˜ë„ë¡ ë‹¨ìˆœí™”

| **ë©”ì„œë“œ** | **ì—”ë“œí¬ì¸íŠ¸**  | **ì—­í• **       |
| ---------- | --------------- | -------------- |
| **GET**    | /users/me       | ë‚´ í”„ë¡œí•„ ì¡°íšŒ |
| **POST**   | /users/signup   | íšŒì›ê°€ì…       |
| **PATCH**  | /users/password | ë¹„ë°€ë²ˆí˜¸ ë³€ê²½  |
| **PATCH**  | /users/nickname | ë‹‰ë„¤ì„ ë³€ê²½    |
| **DELETE** | /users/me       | íšŒì› íƒˆí‡´      |

---

### 3. Villagers

**GET /villagers**

- ì£¼ë¯¼ ì „ì²´ ëª©ë¡ ì¡°íšŒ
- ê¸°ë³¸ ì •ë³´ (ì´ë¦„, ì´ë¯¸ì§€)

**GET /villagers/:id**

- ì£¼ë¯¼ ë‹¨ì¼ ì¡°íšŒ
- ë§íˆ¬ ì˜ˆì‹œ í¬í•¨

ğŸ“Œ í”„ë¡ íŠ¸ì˜ â€œì£¼ë¯¼ í´ë¦­ â†’ ì¹´ë“œ ìƒì„±â€ì— í•„ìš”

| **ë©”ì„œë“œ** | **ì—”ë“œí¬ì¸íŠ¸** | **ì—­í• **            |
| ---------- | -------------- | ------------------- |
| **GET**    | /villagers     | ì£¼ë¯¼ ì „ì²´ ëª©ë¡ ì¡°íšŒ |
| **GET**    | /villagers/:id | ì£¼ë¯¼ ë‹¨ì¼ ì¡°íšŒ      |

---

### 4. Emails

**GET /emails**

- ë‚´ ì´ë©”ì¼ ì´ë ¥ ëª©ë¡ ì¡°íšŒ
- ìƒíƒœë³„ í•„í„°ë§ ê°€ëŠ¥ (reserved / sent)

**GET /emails/:id**

- ì´ë©”ì¼ ë‹¨ì¼ ì¡°íšŒ
- ë³€í™˜ëœ í…ìŠ¤íŠ¸ + ì´ë¯¸ì§€ í¬í•¨

**POST /emails/preview**

- ë¯¸ë¦¬ë³´ê¸°

**POST /emails**

- ìµœì¢… ì´ë©”ì¼ ìƒì„± (ì˜ˆì•½ í¬í•¨)

**DELETE /emails/:id**

- ì´ë©”ì¼ ì´ë ¥ ì‚­ì œ
- ì˜ˆì•½ ìƒíƒœì¼ ê²½ìš° â†’ ì‹¤ì œ ì·¨ì†Œ
- ì „ì†¡ ì™„ë£Œ ìƒíƒœì¼ ê²½ìš° â†’ ì´ë ¥ë§Œ ì‚­ì œ

| **ë©”ì„œë“œ** | **ì—”ë“œí¬ì¸íŠ¸**  | **ì—­í• **                 |
| ---------- | --------------- | ------------------------ |
| **GET**    | /emails         | ë‚´ ì´ë©”ì¼ ì´ë ¥ ëª©ë¡ ì¡°íšŒ |
| **GET**    | /emails/:id     | ì´ë©”ì¼ ë‹¨ì¼ ì¡°íšŒ         |
| **POST**   | /emails         | ì´ë©”ì¼ ì†¡ì‹ (ì˜ˆì•½)        |
| **POST**   | /emails/preview | ì´ë©”ì¼ ë¯¸ë¦¬ë³´ê¸°          |
| **DELETE** | /emails/:id     | ì´ë©”ì¼ ì‚­ì œ              |

---

### POST /emails/preview

ğŸ“Œ **ë¯¸ë¦¬ë³´ê¸° ì „ìš© (DB ì €ì¥ âŒ)**

**Request**

```json
{
  "villagerId": 3,
  "originalText": "ì˜¤ëŠ˜ ì •ë§ ê³ ë§ˆì› ì–´"
}
```

**Response**

```json
{
  "previewText": "ìŒâ€¦ ì˜¤ëŠ˜ ì •ë§ ê³ ë§ˆì› ì–´~",
  "previewImageUrl": null
}
```

---

### POST /emails

ğŸ“Œ **ìµœì¢… ì´ë©”ì¼ ìƒì„± (ì˜ˆì•½ í¬í•¨)**

**Request**

```json
{
  "villagerId": 3,
  "originalText": "ì˜¤ëŠ˜ ì •ë§ ê³ ë§ˆì› ì–´",
  "receiverEmail": "test@example.com",
  "scheduledAt": "2026-01-10T12:00:00Z"
}
```

**Server Behavior**

- tone rule ê¸°ë°˜ ìµœì¢… ë³€í™˜ ìˆ˜í–‰
- transformedText ìƒì„±
- emails í…Œì´ë¸” ì €ì¥

**Timezone Contract (scheduledAt)**

- í”„ë¡ íŠ¸ëŠ” `scheduledAt`ì„ `new Date(...).toISOString()` í˜•íƒœë¡œ ì „ì†¡í•œë‹¤. (UTC, `Z`)
- ë°±ì—”ë“œëŠ” ì´ë¥¼ `Date`ë¡œ íŒŒì‹±í•´ ê·¸ëŒ€ë¡œ `emails.scheduled_at (TIMESTAMP WITH TIME ZONE)`ì— ì €ì¥í•œë‹¤.
- ì˜ˆì•½ ë°œì†¡ ì›Œì»¤ëŠ” â€œdue ì—¬ë¶€â€ë¥¼ ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë²„ ì‹œê°„ì´ ì•„ë‹ˆë¼ **DB `now()` ê¸°ì¤€**ìœ¼ë¡œ ë¹„êµí•œë‹¤.

---

# ë°±ì—”ë“œ ì£¼ì˜ì 

## 1. ì™œ Redisì™€ GPTê°€ â€œìœ„í—˜í•œê°€â€

Redisê°€ ìœ„í—˜í•œ ì´ìœ 

ìƒíƒœë¥¼ DBì²˜ëŸ¼ ì°©ê°í•˜ê¸° ì‰¬ì›€

TTL, eviction, ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë°œìƒ

ë°ì´í„° ìœ ì‹¤ ê°€ëŠ¥ì„±ì´ ê¸°ë³¸ê°’

GPT APIê°€ ìœ„í—˜í•œ ì´ìœ 

ì™¸ë¶€ ì˜ì¡´ì„± (í•­ìƒ ì‹¤íŒ¨ ê°€ëŠ¥)

ë¹„ìš© ë°œìƒ

ì‘ë‹µ ì§€ì—°/ë¶ˆì•ˆì •

ê²°ê³¼ ë¹„ê²°ì •ì„±

ğŸ‘‰ ê³µí†µì 
â€œë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì— ì„ì´ë©´ ì „ì²´ ì‹œìŠ¤í…œì„ ì˜¤ì—¼ì‹œí‚¨ë‹¤â€

## 2. ì ˆëŒ€ í•˜ë©´ ì•ˆ ë˜ëŠ” êµ¬ì¡° âŒ

// emails.service.ts
async createEmail() {
const tone = await this.gpt.call(...); // âŒ
await this.redis.incr(...); // âŒ
this.emailRepo.save(...);
}

ì´ë ‡ê²Œ ë˜ë©´:

í…ŒìŠ¤íŠ¸ ë¶ˆê°€

ì¥ì•  ì „íŒŒ

êµì²´ ë¶ˆê°€

ì±…ì„ ê²½ê³„ ë¶•ê´´

## 3. ì •ë‹µ êµ¬ì¡°: ë ˆì´ì–´ ë¶„ë¦¬

ê¶Œì¥ ë ˆì´ì–´ êµ¬ì¡°
Controller (HTTP)
â†“
Application Service (Use Case)
â†“
Domain Service
â†“
Infrastructure (Redis / GPT)

Nest ê¸°ì¤€ìœ¼ë¡œ í’€ë©´ ì´ë ‡ê²Œ ëœë‹¤.

## 4. NestJS ë””ë ‰í„°ë¦¬ êµ¬ì¡° (ê¶Œì¥)

src/
â”œâ”€ modules/
â”‚ â”œâ”€ emails/
â”‚ â”‚ â”œâ”€ emails.controller.ts
â”‚ â”‚ â”œâ”€ emails.service.ts â† ìœ ìŠ¤ì¼€ì´ìŠ¤ ì¡°í•©ë§Œ
â”‚ â”‚ â””â”€ emails.module.ts
â”‚
â”œâ”€ domain/
â”‚ â”œâ”€ tone/
â”‚ â”‚ â”œâ”€ tone.service.ts â† ë§íˆ¬ ë³€í™˜ ê·œì¹™
â”‚ â”‚ â””â”€ tone.interface.ts
â”‚
â”œâ”€ infra/
â”‚ â”œâ”€ gpt/
â”‚ â”‚ â”œâ”€ gpt.client.ts
â”‚ â”‚ â””â”€ gpt.module.ts
â”‚ â”‚
â”‚ â””â”€ redis/
â”‚ â”œâ”€ redis.client.ts
â”‚ â””â”€ redis.module.ts

## 5. GPT ì„¤ê³„ ì›ì¹™ (ì¤‘ìš”)

GPTëŠ” ë°˜ë“œì‹œ â€œClientâ€ë¡œ ê°ì‹¼ë‹¤
// infra/gpt/gpt.client.ts
export class GptClient {
async transform(systemPrompt: string, input: string): Promise<string> {
// OpenAI API í˜¸ì¶œ
}
}

ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ âŒ

if/else âŒ

tone íŒë‹¨ âŒ

Domain Serviceì—ì„œ GPT ì‚¬ìš©
// domain/tone/tone.service.ts
export class ToneService {
constructor(private readonly gpt: GptClient) {}

async transform(input: string, tone: VillagerTone): Promise<string> {
if (tone.type === 'GPT') {
return this.gpt.transform(tone.systemPrompt, input);
}
return applyRule(input, tone);
}
}

â†’ GPTëŠ” ë„êµ¬ì¼ ë¿
â†’ íŒë‹¨ì€ Domainì—ì„œ

## 6. Redis ì„¤ê³„ ì›ì¹™ (ì¤‘ìš”)

RedisëŠ” â€œìºì‹œ + ì¹´ìš´í„°â€ë§Œ ë‹´ë‹¹
// infra/redis/redis.client.ts
export class RedisClient {
async incr(key: string): Promise<number> {}
async get(key: string): Promise<string | null> {}
}

ë„ë©”ì¸ ì˜ë¯¸ ì—†ìŒ

key ê·œì¹™ë§Œ ì¡´ì¬

Domainì—ì„œ ì˜ë¯¸ ë¶€ì—¬
// domain/popularity/popularity.service.ts
export class PopularityService {
constructor(private redis: RedisClient) {}

async increaseVillagerUsage(villagerId: number) {
await this.redis.incr(`villager:${villagerId}:usage`);
}
}

## 7. Application ServiceëŠ” â€œì¡°ë¦½ìâ€

// emails.service.ts
async createEmail(dto) {
const tone = await this.toneRepo.findByVillager(dto.villagerId);

const transformed = await this.toneService.transform(
dto.originalText,
tone
);

await this.popularityService.increaseVillagerUsage(dto.villagerId);

await this.emailRepo.save({
...dto,
transformedText: transformed,
});
}

ğŸ‘‰ ì—¬ê¸°ì—” Redis, GPT ì½”ë“œê°€ ë‹¨ í•œ ì¤„ë„ ì—†ë‹¤

## 8. ì´ êµ¬ì¡°ì˜ ì••ë„ì  ì¥ì 

í•­ëª© íš¨ê³¼
í…ŒìŠ¤íŠ¸ GPT/Redis mocking ì‰¬ì›€
ì¥ì•  GPT ì‹¤íŒ¨ â†’ Domainì—ì„œ fallback
êµì²´ GPT â†’ ë‹¤ë¥¸ ëª¨ë¸ ì¦‰ì‹œ ê°€ëŠ¥
í•™ìŠµ MVC ê¹¨ë—
í™•ì¥ ì–´ë“œë¯¼, ë°°ì¹˜ ì‘ì—… ì¶”ê°€ ì‰¬ì›€

## 9. â€œMVCì—ì„œ ë°°ì œí•´ì•¼ í•˜ë‚˜?â€ì— ëŒ€í•œ ì •í™•í•œ ë‹µ

âŒ ì™„ì „ ë°°ì œ

ì»¨íŠ¸ë¡¤ëŸ¬, ì—”í‹°í‹°, ë¦¬í¬ì§€í† ë¦¬

âœ” ë ˆì´ì–´ ì™¸ë¶€ë¡œ ì™„ì „ ë¶„ë¦¬

Infra (Client)

Domain Service (íŒë‹¨)

ğŸ‘‰ MVCëŠ” â€œì…ì¶œë ¥â€
ğŸ‘‰ Redis / GPTëŠ” â€œí™˜ê²½â€
